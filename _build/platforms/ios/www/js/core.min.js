/*! com.n2d.Domicila 17-03-2015 */
var strings={loginFail:"Login details do not exist. /sadface"},meta={geo:{updated:_.now(),longitude:-97.1459262,latitude:49.8928523},locations:[{a:"324 St. Johns Avenue",lon:-97.1316184,lat:49.9212885},{a:"549 Castle Avenue",lon:-97.0967149,lat:49.9066913},{a:"1234 Corydon Avenue",lon:-97.1731519,lat:49.8640781},{a:"Apt 30, 555 St. Mary Avenue",lon:-97.1518443,lat:49.8890405},{a:"10 Marble Avenue",lon:-97.2116321,lat:49.9362962}]},touch={addE:function(){$(".touchable").on("mousedown touchstart",function(){$(".touched").removeClass("touched"),$(this).addClass("touched")}),$(".touchable").on("mouseup touchend touchcancel",function(){$(".touched").removeClass("touched")})},remE:function(){$(".touchable").off("mousedown touchstart"),$(".touchable").off("mouseup touchend touchcancel")},initialize:function(){touch.addE()},reset:function(){touch.remE(),touch.initialize()}},app={initialize:function(){console.log("App init"),Parse.initialize("OfIvWaRe1ZvcA0x5BTK1hwPq9hEOB9Ksfi64kysX","NWMRCKtj5OFisw0X3GJk3zZFT6k2CRkMtMkh3uZD"),app.bindEvents(),views.initialize(),touch.initialize()},bindEvents:function(){document.addEventListener("deviceready",this.onDeviceReady,!1)},onDeviceReady:function(){console.log("Device is ready")},getLocation:function(a){a&&(navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){meta.geo.longitude=a.coords.longitude,meta.geo.latitude=a.coords.latitude;var b=new Parse.GeoPoint({latitude:meta.geo.latitude,longitude:meta.geo.longitude});Parse.User.current().set("Geo",b),Parse.User.current().save(null,{success:function(){console.log("Updated User's Geolocation")},error:function(a,b){console.error("Failed to update User's Geolocation"),console.error(b)}})}):console.log("Location not found."))}},views={initialize:function(){console.log("View inits"),menu.initialize(),Parse.User.current()?(views.modals.addLocation.initialize(),views.screens.list.initialize()):views.screens.login.initialize()},screens:{login:{initialize:function(){console.log("Loading login screen..."),$.when(views.screens.login.getData()).done(views.screens.login.render())},getData:function(){console.log("Loading login screen data...done.")},render:function(){console.log("Rendering login screen..."),$.when(views.screens.login.remE()).done(function(){$("app screen").addClass("hidden"),views.screens.login.addE(),$("screen#login").removeClass("hidden")})},addE:function(){$("screen#login #btn_goToSignup").hammer().on("tap",function(a){a.preventDefault(),$("app screen").addClass("hidden"),views.screens.signup.initialize()}),$("screen#login #frm_login").on("submit",function(a){$("screen#login #btn_login").prop("disabled",!0),Parse.User.logIn($("screen#login #frm_login #txt_user").val(),$("screen#login #frm_login #txt_pass").val(),{success:function(a){console.log("Parse.User.logIn Success"),console.log(a),views.screens.list.initialize(),setTimeout(function(){$("screen#login #btn_login").prop("disabled",!1),$("screen#login #frm_login")[0].reset()},500)},error:function(a,b){switch(console.error("Parse.User.logIn Error"),b.code){case 101:$("screen#login #feedback_login").html(strings.loginFail);default:console.error(a),console.error(b)}setTimeout(function(){$("screen#login #feedback_login").html(" "),$("screen#login #btn_login").prop("disabled",!1)},3e3)}}),a.preventDefault()})},remE:function(){$("screen#login #btn_goToSignup").hammer().off("tap"),$("screen#login #frm_login").off("submit")}},signup:{initialize:function(){console.log("Loading signup screen..."),$.when(views.screens.signup.getData()).done(views.screens.signup.render())},getData:function(){console.log("Loading signup screen data...done.")},render:function(){console.log("Rendering signup screen..."),$.when(views.screens.signup.remE()).done(function(){$("app screen").addClass("hidden"),views.screens.signup.addE(),$("screen#signup").removeClass("hidden")})},addE:function(){$("screen#signup #btn_cancel").hammer().on("tap",function(a){$("app screen").addClass("hidden"),views.screens.login.initialize(),a.preventDefault()}),$("screen#signup #frm_signup #txt_pass2").on("keyup",function(){$(this).val()==$("screen#signup #frm_signup #txt_pass1").val()?($(this).removeClass("bad"),$(this).addClass("good")):($(this).removeClass("good"),$(this).addClass("bad")),0==$("screen#signup #frm_signup .bad").length?$("screen#signup #btn_submit").prop("disabled",!1):$("screen#signup #btn_submit").prop("disabled",!0)}),$("screen#signup #frm_signup").on("submit",function(a){$("screen#signup #btn_signup").prop("disabled",!0);var b=new Parse.User;b.set("firstname",$("screen#signup #frm_signup #txt_fName").val()),b.set("username",$("screen#signup #frm_signup #txt_uName").val()),b.set("email",$("screen#signup #frm_signup #txt_email").val()),b.set("password",$("screen#signup #frm_signup #txt_pass1").val()),b.signUp(null,{success:function(){console.log("Parse.User.signUp Success"),views.screens.list.initialize()},error:function(a,b){console.log("Parse.User.signUp Error"),console.error(b),setTimeout(function(){$("screen#signup #btn_signup").prop("disabled",!1)},3e3)}}),a.preventDefault()})},remE:function(){$("screen#signup #btn_cancel").hammer().off("tap"),$("screen#signup #frm_signup #txt_pass2").off("keyup"),$("screen#signup #frm_signup").off("submit")}},list:{initialize:function(){console.log("Determining user's location..."),app.getLocation(!0),console.log("Loading list of locations..."),$.when(views.screens.list.getData()).done(views.screens.list.render())},getData:function(){_.each(meta.locations,function(a,b){meta.locations[b].d=utility.getDist(a.lon,a.lat),meta.locations[b].t=utility.getTimeToDist(a.d)}),meta.locations=_.sortBy(meta.locations,function(a){return a.d})},render:function(){$("app screen").addClass("hidden"),$.when(views.screens.list.remE()).done(function(){views.screens.list.addE(),$("screen#list").removeClass("hidden"),$("screen#list content").html("");for(var a=_.template($("#tpl_card").html()),b=meta.locations.length-1;b>=0;b--)$("screen#list content").prepend(a(meta.locations[b]))})},remE:function(){$("screen#list #btn_toggleMenu").hammer().off("tap"),$("screen#list #btn_refreshDistance").hammer().off("tap"),$("screen#list #btn_addLocation").hammer().off("tap")},addE:function(){$("screen#list #btn_toggleMenu").hammer().on("tap",function(){$(this).addClass("spinFaceLeft"),setTimeout(menu.show,300)}),$("screen#list #btn_refreshDistance").hammer().on("tap",function(){$(this).toggleClass("disabled"),$(this).toggleClass("infiniteSpin")}),$("screen#list #btn_addLocation").hammer().on("tap",function(){views.modals.addLocation.show()})}},detail:{initialize:function(){},getData:function(){},render:function(){}}},modals:{addLocation:{initialize:function(){$.when(views.modals.addLocation.remE()).done(views.modals.addLocation.addE())},show:function(){$("screen").not(".hidden").addClass("fadeAway"),$("modal#addLocation").removeClass("viewportBottom")},hide:function(){$("modal#addLocation").addClass("viewportBottom"),$("screen").not(".hidden").removeClass("fadeAway")},setData:function(){},remE:function(){$("modal#addLocation #btn_cancel").hammer().off("tap"),$("modal#addLocation #btn_save").hammer().off("tap")},addE:function(){$("modal#addLocation #btn_cancel").hammer().on("tap",function(){views.modals.addLocation.hide()}),$("modal#addLocation #btn_save").hammer().on("tap",function(){$.when(views.modals.addLocation.setData()).done(views.modals.addLocation.hide())})}}}},menu={initialize:function(){$("menu").addClass("menu-left"),$("app").removeClass("tiltBack"),$.when(menu.remE()).done(menu.addE())},show:function(){console.log("Showing Menu"),$("app").addClass("tiltBack"),$("menu").removeClass("menu-left"),$("app screen").not(".hidden").each(function(a,b){window.views.screens[$(b).attr("id")].remE()}),setTimeout(function(){$("app").hammer().one("tap hold",function(){menu.hide()})},500)},hide:function(){console.log("Hiding Menu"),$("menu").addClass("menu-left"),$("app").removeClass("tiltBack"),$("app screen").not(".hidden").each(function(a,b){window.views.screens[$(b).attr("id")].addE()}),setTimeout(function(){$(".spinFaceLeft").removeClass("spinFaceLeft")},300)},remE:function(){$("menu #btn_menu_locations").hammer().off("tap"),$("menu #btn_menu_favs").hammer().off("tap"),$("menu #btn_menu_settings").hammer().off("tap"),$("menu #btn_menu_logout").hammer().off("tap")},addE:function(){$("menu #btn_menu_locations").hammer().on("tap",function(){}),$("menu #btn_menu_favs").hammer().on("tap",function(){}),$("menu #btn_menu_settings").hammer().on("tap",function(){}),$("menu #btn_menu_logout").hammer().on("tap",function(){Parse.User.logOut(),views.initialize()})}},utility={deg2rad:function(a){return a*(Math.PI/180)},getDist:function(a,b){var c={lon:a,lat:b},d=6371,e=utility.deg2rad(parseFloat(meta.geo.latitude)-parseFloat(c.lat)),f=utility.deg2rad(parseFloat(meta.geo.longitude)-parseFloat(c.lon)),g=Math.sin(e/2)*Math.sin(e/2)+Math.cos(utility.deg2rad(parseFloat(c.lat)))*Math.cos(utility.deg2rad(parseFloat(meta.geo.latitude)))*Math.sin(f/2)*Math.sin(f/2),h=2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g)),i=d*h,j=+i.toFixed(2);return j},getTimeToDist:function(a,b){b||(b=35);var c=a/b*60,d=+c.toFixed(0);return d},openAppleMaps:function(a,b){window.location.href="maps://maps.apple.com/?q="+b+","+a},geolocate:function(a){var b={};$.getJSON("https://maps.googleapis.com/maps/api/geocode/json?address="+encodeURI(a)+"&key=AIzaSyAYfY4a-BeFVOLsgW2EudijdAV9GCmAXx4").done(function(a){return meta.tempGeolocate=a,b=a.results[0].geometry.location}).fail(function(a,b,c){console.error(c)})}};$(function(){app.initialize()});