/*! com.n2d.Domicila 27-03-2015 */
var strings={loginFail:"Login details do not exist. /sadface"},meta={keys:{google:{ios:"AIzaSyAYfY4a-BeFVOLsgW2EudijdAV9GCmAXx4",web:"AIzaSyAYfY4a-BeFVOLsgW2EudijdAV9GCmAXx4",android:"AIzaSyAYfY4a-BeFVOLsgW2EudijdAV9GCmAXx4",current:""}},locations:[],oldLocations:[{a:"324 St. Johns Avenue",lon:-97.1316184,lat:49.9212885},{a:"549 Castle Avenue",lon:-97.0967149,lat:49.9066913},{a:"1234 Corydon Avenue",lon:-97.1731519,lat:49.8640781},{a:"Apt 30, 555 St. Mary Avenue",lon:-97.1518443,lat:49.8890405},{a:"10 Marble Avenue",lon:-97.2116321,lat:49.9362962}],lastLocationSearch:{}},touch={addE:function(){return $.Deferred(function(a){$(".touchable").on("mousedown touchstart",function(){$(".touched").removeClass("touched"),$(this).addClass("touched")}),$(".touchable").on("mouseup touchend touchcancel",function(){$(".touched").removeClass("touched")}),a.resolve()})},remE:function(){return $.Deferred(function(a){$(".touchable").off("mousedown touchstart"),$(".touchable").off("mouseup touchend touchcancel"),a.resolve()})},initialize:function(){touch.remE().done(touch.addE)},reset:function(){touch.remE().done(touch.addE)}},app={initialize:function(){console.log("App init"),Parse.initialize("OfIvWaRe1ZvcA0x5BTK1hwPq9hEOB9Ksfi64kysX","NWMRCKtj5OFisw0X3GJk3zZFT6k2CRkMtMkh3uZD"),meta.keys.google.current=meta.keys.google.web,app.bindEvents(),views.initialize(),touch.initialize()},bindEvents:function(){document.addEventListener("deviceready",this.onDeviceReady,!1)},onDeviceReady:function(){console.log("Device is ready"),"ios"==device.platform.toLowerCase()&&(meta.keys.google.current=meta.keys.google.ios)},getLocation:function(a){a&&(navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){meta.geo.longitude=a.coords.longitude,meta.geo.latitude=a.coords.latitude;var b=new Parse.GeoPoint({latitude:meta.geo.latitude,longitude:meta.geo.longitude});Parse.User.current().set("Geo",b),Parse.User.current().save(null,{success:function(){console.log("Updated User's Geolocation")},error:function(a,b){console.error("Failed to update User's Geolocation"),console.error(b)}})}):console.log("Location not found."))}},views={initialize:function(){console.log("View inits"),menu.initialize(),Parse.User.current()?views.screens.list.initialize():views.screens.login.initialize()},screens:{login:{initialize:function(){console.log("Loading login screen..."),$.when(views.screens.login.getData()).done(views.screens.login.render())},getData:function(){console.log("Loading login screen data...done.")},render:function(){console.log("Rendering login screen..."),$.when(views.screens.login.remE()).done(function(){$("app screen").addClass("hidden"),views.screens.login.addE(),$("screen#login").removeClass("hidden")})},addE:function(){$("screen#login #btn_goToSignup").hammer().on("tap",function(a){a.preventDefault(),$("app screen").addClass("hidden"),views.screens.signup.initialize()}),$("screen#login #frm_login").on("submit",function(a){$("screen#login #btn_login").prop("disabled",!0),Parse.User.logIn($("screen#login #frm_login #txt_user").val(),$("screen#login #frm_login #txt_pass").val(),{success:function(a){console.log("Parse.User.logIn Success"),console.log(a),views.screens.list.initialize(),setTimeout(function(){$("screen#login #btn_login").prop("disabled",!1),$("screen#login #frm_login")[0].reset()},500)},error:function(a,b){switch(console.error("Parse.User.logIn Error"),b.code){case 101:$("screen#login #feedback_login").html(strings.loginFail);default:console.error(a),console.error(b)}setTimeout(function(){$("screen#login #feedback_login").html(" "),$("screen#login #btn_login").prop("disabled",!1)},3e3)}}),$("input, select, textarea, button").blur(),a.preventDefault()})},remE:function(){$("screen#login #btn_goToSignup").hammer().off("tap"),$("screen#login #frm_login").off("submit")}},signup:{initialize:function(){console.log("Loading signup screen..."),$.when(views.screens.signup.getData()).done(views.screens.signup.render())},getData:function(){console.log("Loading signup screen data...done.")},render:function(){console.log("Rendering signup screen..."),$.when(views.screens.signup.remE()).done(function(){$("app screen").addClass("hidden"),views.screens.signup.addE(),$("screen#signup").removeClass("hidden")})},addE:function(){$("screen#signup #btn_cancel").hammer().on("tap",function(a){$("app screen").addClass("hidden"),views.screens.login.initialize(),a.preventDefault()}),$("screen#signup #frm_signup #txt_pass2").on("keyup",function(){$(this).val()==$("screen#signup #frm_signup #txt_pass1").val()?($(this).removeClass("bad"),$(this).addClass("good")):($(this).removeClass("good"),$(this).addClass("bad")),0==$("screen#signup #frm_signup .bad").length?$("screen#signup #btn_submit").prop("disabled",!1):$("screen#signup #btn_submit").prop("disabled",!0)}),$("screen#signup #frm_signup").on("submit",function(a){$("screen#signup #btn_signup").prop("disabled",!0);var b=new Parse.User;b.set("firstname",$("screen#signup #frm_signup #txt_fName").val()),b.set("username",$("screen#signup #frm_signup #txt_uName").val()),b.set("email",$("screen#signup #frm_signup #txt_email").val()),b.set("password",$("screen#signup #frm_signup #txt_pass1").val()),b.signUp(null,{success:function(){console.log("Parse.User.signUp Success"),views.screens.list.initialize()},error:function(a,b){console.log("Parse.User.signUp Error"),console.error(b),setTimeout(function(){$("screen#signup #btn_signup").prop("disabled",!1)},3e3)}}),$("input, select, textarea, button").blur(),a.preventDefault()})},remE:function(){$("screen#signup #btn_cancel").hammer().off("tap"),$("screen#signup #frm_signup #txt_pass2").off("keyup"),$("screen#signup #frm_signup").off("submit")}},list:{initialize:function(){views.screens.list.render(),views.screens.list.getData()},getData:function(a){$("screen#list #btn_refreshDistance").addClass("disabled"),$("screen#list #btn_refreshDistance").addClass("infiniteSpin"),a&&$("screen#list content").html("Loading..."),$.when(utility.deferredGetLocation(!0,a)).then(function(a){var b=new Parse.Query(Parse.Object.extend("Locations"));b.near("Geo",a),b.find({success:function(){meta.locations=Parse.Collection.extend({model:Parse.Object.extend("Locations")});var a=new meta.locations;a.fetch({success:function(a){$("screen#list content").html("");var b=_.template($("#tpl_card").html()),c=[];_.each(a.models,function(a){var b={};b.geo=a.get("Geo"),b.name=a.get("Name"),b.address=a.get("Address1"),b.d=utility.getDist(b.geo.longitude,b.geo.latitude),b.t=utility.getTimeToDist(b.d),c.push(b)}),c=_.sortBy(c,function(a){return a.d}),_.each(c,function(a){$("screen#list content").append(b(a)),setTimeout(function(){$("screen#list content card").addClass("visible")},1750)}),touch.reset(),views.screens.list.remE().done(views.screens.list.addE)},error:function(a,b){$("screen#list content").html("Could not load your Locations"),console.log("Failed creating nearby collection"),console.log(b)}})},error:function(a,b){$("screen#list content").html("Could not load your Locations"),console.log("Error querying Locations"),console.log(b)}})}).fail(function(a){$("screen#list content").html("Could not load your current location."),console.error(a)}).always(function(){$("screen#list #btn_refreshDistance").removeClass("disabled"),$("screen#list #btn_refreshDistance").removeClass("infiniteSpin")})},render:function(){$("app screen").addClass("hidden"),views.screens.list.remE().done(function(){views.screens.list.addE(),$("screen#list").removeClass("hidden")})},remE:function(){return $.Deferred(function(a){$("screen#list #btn_toggleMenu").hammer().off("tap"),$("screen#list #btn_refreshDistance").hammer().off("tap"),$("screen#list #btn_addLocation").hammer().off("tap"),$("screen#list content card").hammer().off("tap"),a.resolve()})},addE:function(){return $.Deferred(function(a){$("screen#list #btn_toggleMenu").hammer().on("tap",function(){$(this).addClass("spinFaceLeft"),setTimeout(menu.show,300)}),$("screen#list #btn_refreshDistance").hammer().on("tap",function(){views.screens.list.getData(!0)}),$("screen#list #btn_addLocation").hammer().on("tap",function(){$.when(views.modals.addLocation.initialize()).done(views.modals.addLocation.show())}),$("screen#list content card").hammer().on("tap",function(){}),a.resolve()})}},detail:{initialize:function(){},getData:function(){},render:function(){}}},modals:{addLocation:{initialize:function(){$.when(views.modals.addLocation.remE()).done(views.modals.addLocation.addE())},show:function(){var a=Parse.Object.extend("Locations");meta.tempLocation=new a,views.modals.addLocation.getNearbyLocations(),$("screen").not(".hidden").addClass("fadeAway"),$("modal#addLocation").removeClass("viewportBottom"),$("modal#addLocation tabgroup#"+$("modal#addLocation tab.active").attr("for")).removeClass("hidden")},hide:function(){$("modal#addLocation").addClass("viewportBottom"),$("screen").not(".hidden").removeClass("fadeAway"),setTimeout(function(){$("modal#addLocation content tabgroup").addClass("hidden")},1e3)},getNearbyLocations:function(){console.log("getNearbyLocations"),utility.deferredGetLocation(!0).then(function(a){utility.deferredGetAddress(a).then(function(a){_.each(a.results,function(a,b){a.sequence=b;var c=_.template($("#tpl_modal-addLocation_data-item").html());$("modal#addLocation results").append(c(a)),views.modals.addLocation.remListE().done(views.modals.addLocation.addListE)})})})},loadDataIntoForm:function(a){var b="",c=$("modal#addLocation #txt_name").val();$("modal#addLocation #frm_details")[0].reset(),$("modal#addLocation #txt_name").val(c),$("modal#addLocation #txt_lat").val(a.geometry.location.lat),$("modal#addLocation #txt_lng").val(a.geometry.location.lng),$.each(a.address_components,function(c,d){$.each(d.types,function(d,e){"locality"==e&&$("modal#addLocation #txt_city").val(a.address_components[c].long_name),"street_number"==e&&(b=a.address_components[c].long_name),"route"==e&&(b+=" "+a.address_components[c].long_name,$("modal#addLocation #txt_address1").val(b)),"administrative_area_level_1"==e&&$("modal#addLocation #txt_region").val(a.address_components[c].long_name),"country"==e&&$("modal#addLocation #txt_country").val(a.address_components[c].short_name),("postal_code"==e||"zip_code"==e)&&$("modal#addLocation #txt_code").val(a.address_components[c].short_name)})})},setData:function(){meta.tempLocation.set("createdBy",Parse.User.current()),meta.tempLocation.set("Name",name);var a=new Parse.GeoPoint({latitude:parseFloat($("modal#addLocation #txt_lat").val()),longitude:parseFloat($("modal#addLocation #txt_lng").val())});meta.tempLocation.set("Geo",a),meta.tempLocation.set("City",$("modal#addLocation #txt_city").val()),meta.tempLocation.set("Address1",$("modal#addLocation #txt_address1").val()),meta.tempLocation.set("Region",$("modal#addLocation #txt_region").val()),meta.tempLocation.set("Country",$("modal#addLocation #txt_country").val()),meta.tempLocation.set("Code",$("modal#addLocation #txt_code").val()),meta.tempLocation.save({success:function(a){console.log(a)},error:function(a,b){console.error(b),alert(b.message)}}),meta.tempLocation=null,$("modal#addLocation #frm_details")[0].reset(),$("input, select, textarea, button").blur(),$("modal#addLocation results").html(""),views.modals.addLocation.hide()},remE:function(){$("modal#addLocation #btn_cancel").hammer().off("tap"),$("modal#addLocation #btn_save").hammer().off("tap"),$("modal#addLocation tabs tab").hammer().off("tap"),$("modal#addLocation form#frm_details #txt_address1, modal#addLocation form#frm_details #txt_city").off("blur"),$("modal#addLocation form#frm_details").off("submit")},addE:function(){$("modal#addLocation #btn_cancel").hammer().on("tap",function(){views.modals.addLocation.hide()}),$("modal#addLocation #btn_save").hammer().on("tap",function(){$.when(views.modals.addLocation.setData()).done(function(){views.screens.list.getData(!0),views.modals.addLocation.hide()})}),$("modal#addLocation tabs tab").hammer().on("tap",function(){$("modal#addLocation tabs tab").removeClass("active"),$(this).addClass("active"),$("modal#addLocation tabgroup").addClass("hidden"),$("modal#addLocation tabgroup#"+$("modal#addLocation tab.active").attr("for")).removeClass("hidden")}),$("modal#addLocation form#frm_details #txt_address1, modal#addLocation form#frm_details #txt_city").on("blur",function(){var a=$("modal#addLocation #txt_address1").val()+","+$("modal#addLocation #txt_city").val();$.when(utility.geolocate(a)).done(function(b){console.log(a),console.log(b)})}),$("modal#addLocation form#frm_details").on("submit",function(a){var b=$("modal#addLocation #txt_address1").val()+","+$("modal#addLocation #txt_city").val(),c=utility.geolocate(b);console.log(b),console.log(c),$("input, select, textarea, button").blur(),a.preventDefault()})},remListE:function(){return $.Deferred(function(a){$("modal#addLocation form results item").hammer().off("tap"),a.resolve()})},addListE:function(){return $.Deferred(function(a){$("modal#addLocation form results item").hammer().on("tap",function(){$("modal#addLocation form results item").removeClass("selected"),$(this).addClass("selected");var a=parseInt($(this).data("id"));console.log(a),views.modals.addLocation.loadDataIntoForm(meta.lastLocationSearch.results[a])}),a.resolve()})}}}},menu={initialize:function(){$("menu").addClass("menu-left"),$("app").removeClass("tiltBack"),$.when(menu.remE()).done(menu.addE())},show:function(){console.log("Showing Menu"),$("app").addClass("tiltBack"),$("menu").removeClass("menu-left"),$("app screen").not(".hidden").each(function(a,b){window.views.screens[$(b).attr("id")].remE()}),setTimeout(function(){$("app").hammer().one("tap hold",function(){menu.hide()})},500)},hide:function(){console.log("Hiding Menu"),$("menu").addClass("menu-left"),$("app").removeClass("tiltBack"),$("app screen").not(".hidden").each(function(a,b){window.views.screens[$(b).attr("id")].addE()}),setTimeout(function(){$(".spinFaceLeft").removeClass("spinFaceLeft")},300)},remE:function(){$("menu #btn_menu_locations").hammer().off("tap"),$("menu #btn_menu_favs").hammer().off("tap"),$("menu #btn_menu_settings").hammer().off("tap"),$("menu #btn_menu_logout").hammer().off("tap")},addE:function(){$("menu #btn_menu_locations").hammer().on("tap",function(){}),$("menu #btn_menu_favs").hammer().on("tap",function(){}),$("menu #btn_menu_settings").hammer().on("tap",function(){}),$("menu #btn_menu_logout").hammer().on("tap",function(){Parse.User.logOut(),views.initialize()})}},utility={dateDiff:function(a,b){return b||(b=new Date),a-b},deg2rad:function(a){return a*(Math.PI/180)},getDist:function(a,b){var c={lon:a,lat:b},d=6371,e=utility.deg2rad(parseFloat(Parse.User.current().get("Geo").latitude)-parseFloat(c.lat)),f=utility.deg2rad(parseFloat(Parse.User.current().get("Geo").longitude)-parseFloat(c.lon)),g=Math.sin(e/2)*Math.sin(e/2)+Math.cos(utility.deg2rad(parseFloat(c.lat)))*Math.cos(utility.deg2rad(parseFloat(Parse.User.current().get("Geo").latitude)))*Math.sin(f/2)*Math.sin(f/2),h=2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g)),i=d*h,j=+i.toFixed(2);return j},getTimeToDist:function(a,b){b||(b=35);var c=a/b*60,d=+c.toFixed(0);return d},openAppleMaps:function(a,b){window.location.href="maps://maps.apple.com/?q="+b+","+a},geolocate:function(a){var b={};$.getJSON("https://maps.googleapis.com/maps/api/geocode/json?address="+encodeURI(a)+"&key="+meta.keys.google.current).done(function(a){return meta.tempGeolocate=a,b=a.results[0].geometry.location,meta.locations=a.results,b}).fail(function(a,b,c){console.error(c)})},reverseGeoCode:function(a,b,c){var d="https://maps.googleapis.com/maps/api/geocode/json?latlng="+a+","+b+"&key="+meta.keys.google.current;$.getJSON(d).done(function(a){console.log("Got address(es)"),meta.lastLocationSearch=a}).fail(function(a,b,c){console.error(c)}).always(c)},deferredGetLocation:function(a,b){return $.Deferred(function(c){utility.dateDiff(Parse.User.current().get("GeoAt"))<=3e5||1==b?1==a?navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){var b=new Parse.GeoPoint({latitude:a.coords.latitude,longitude:a.coords.longitude});Parse.User.current().set("Geo",b),Parse.User.current().set("GeoAt",new Date),Parse.User.current().save(null,{success:function(){console.log("Parse: Updated User's Geolocation")},error:function(a,b){console.error("Parse: Failed to update User's Geolocation"),console.error(b)}}),c.resolve(b)}):(c.reject({error:"Browser doesn't support HTML5 Geolocation."}),console.error("Browser doesn't support HTML5 Geolocation.")):c.reject({error:"Must use useHTML5geoBoolean"}):c.resolve(Parse.User.current().get("Geo"))}).promise()},deferredGetAddress:function(a){var b;return b=a?"https://maps.googleapis.com/maps/api/geocode/json?latlng="+a.latitude+","+a.longitude+"&key="+meta.keys.google.current:"https://maps.googleapis.com/maps/api/geocode/json?latlng="+Parse.User.current().get("Geo").latitude+","+Parse.User.current().get("Geo").longitude+"&key="+meta.keys.google.current,$.getJSON(b).done(function(a){console.log("Got address(es)"),meta.lastLocationSearch=a}).fail(function(a,b,c){console.error(c)})}};$(function(){app.initialize()});