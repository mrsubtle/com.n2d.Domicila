/*! com.n2d.Domicila 20-03-2015 */
var strings={loginFail:"Login details do not exist. /sadface"},meta={keys:{google:{ios:"AIzaSyCNLRT_u09YBOx-SL76CAZny2Z3xtOQn64",web:"AIzaSyAYfY4a-BeFVOLsgW2EudijdAV9GCmAXx4",android:"",current:""}},geo:{updated:_.now(),longitude:-97.1459262,latitude:49.8928523,city:""},locations:[],oldLocations:[{a:"324 St. Johns Avenue",lon:-97.1316184,lat:49.9212885},{a:"549 Castle Avenue",lon:-97.0967149,lat:49.9066913},{a:"1234 Corydon Avenue",lon:-97.1731519,lat:49.8640781},{a:"Apt 30, 555 St. Mary Avenue",lon:-97.1518443,lat:49.8890405},{a:"10 Marble Avenue",lon:-97.2116321,lat:49.9362962}],lastLocationSearch:{}},touch={addE:function(){$(".touchable").on("mousedown touchstart",function(){$(".touched").removeClass("touched"),$(this).addClass("touched")}),$(".touchable").on("mouseup touchend touchcancel",function(){$(".touched").removeClass("touched")})},remE:function(){$(".touchable").off("mousedown touchstart"),$(".touchable").off("mouseup touchend touchcancel")},initialize:function(){touch.addE()},reset:function(){touch.remE(),touch.initialize()}},app={initialize:function(){console.log("App init"),Parse.initialize("OfIvWaRe1ZvcA0x5BTK1hwPq9hEOB9Ksfi64kysX","NWMRCKtj5OFisw0X3GJk3zZFT6k2CRkMtMkh3uZD"),meta.keys.google.current=meta.keys.google.web,app.bindEvents(),views.initialize(),touch.initialize()},bindEvents:function(){document.addEventListener("deviceready",this.onDeviceReady,!1)},onDeviceReady:function(){console.log("Device is ready"),"ios"==device.platform.toLowerCase()&&(meta.keys.google.current=meta.keys.google.ios)},getLocation:function(a){a&&(navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){meta.geo.longitude=a.coords.longitude,meta.geo.latitude=a.coords.latitude;var b=new Parse.GeoPoint({latitude:meta.geo.latitude,longitude:meta.geo.longitude});Parse.User.current().set("Geo",b),Parse.User.current().save(null,{success:function(){console.log("Updated User's Geolocation")},error:function(a,b){console.error("Failed to update User's Geolocation"),console.error(b)}})}):console.log("Location not found."))}},views={initialize:function(){console.log("View inits"),menu.initialize(),Parse.User.current()?views.screens.list.initialize():views.screens.login.initialize()},screens:{login:{initialize:function(){console.log("Loading login screen..."),$.when(views.screens.login.getData()).done(views.screens.login.render())},getData:function(){console.log("Loading login screen data...done.")},render:function(){console.log("Rendering login screen..."),$.when(views.screens.login.remE()).done(function(){$("app screen").addClass("hidden"),views.screens.login.addE(),$("screen#login").removeClass("hidden")})},addE:function(){$("screen#login #btn_goToSignup").hammer().on("tap",function(a){a.preventDefault(),$("app screen").addClass("hidden"),views.screens.signup.initialize()}),$("screen#login #frm_login").on("submit",function(a){$("screen#login #btn_login").prop("disabled",!0),Parse.User.logIn($("screen#login #frm_login #txt_user").val(),$("screen#login #frm_login #txt_pass").val(),{success:function(a){console.log("Parse.User.logIn Success"),console.log(a),views.screens.list.initialize(),setTimeout(function(){$("screen#login #btn_login").prop("disabled",!1),$("screen#login #frm_login")[0].reset()},500)},error:function(a,b){switch(console.error("Parse.User.logIn Error"),b.code){case 101:$("screen#login #feedback_login").html(strings.loginFail);default:console.error(a),console.error(b)}setTimeout(function(){$("screen#login #feedback_login").html(" "),$("screen#login #btn_login").prop("disabled",!1)},3e3)}}),$("input, select, textarea, button").blur(),a.preventDefault()})},remE:function(){$("screen#login #btn_goToSignup").hammer().off("tap"),$("screen#login #frm_login").off("submit")}},signup:{initialize:function(){console.log("Loading signup screen..."),$.when(views.screens.signup.getData()).done(views.screens.signup.render())},getData:function(){console.log("Loading signup screen data...done.")},render:function(){console.log("Rendering signup screen..."),$.when(views.screens.signup.remE()).done(function(){$("app screen").addClass("hidden"),views.screens.signup.addE(),$("screen#signup").removeClass("hidden")})},addE:function(){$("screen#signup #btn_cancel").hammer().on("tap",function(a){$("app screen").addClass("hidden"),views.screens.login.initialize(),a.preventDefault()}),$("screen#signup #frm_signup #txt_pass2").on("keyup",function(){$(this).val()==$("screen#signup #frm_signup #txt_pass1").val()?($(this).removeClass("bad"),$(this).addClass("good")):($(this).removeClass("good"),$(this).addClass("bad")),0==$("screen#signup #frm_signup .bad").length?$("screen#signup #btn_submit").prop("disabled",!1):$("screen#signup #btn_submit").prop("disabled",!0)}),$("screen#signup #frm_signup").on("submit",function(a){$("screen#signup #btn_signup").prop("disabled",!0);var b=new Parse.User;b.set("firstname",$("screen#signup #frm_signup #txt_fName").val()),b.set("username",$("screen#signup #frm_signup #txt_uName").val()),b.set("email",$("screen#signup #frm_signup #txt_email").val()),b.set("password",$("screen#signup #frm_signup #txt_pass1").val()),b.signUp(null,{success:function(){console.log("Parse.User.signUp Success"),views.screens.list.initialize()},error:function(a,b){console.log("Parse.User.signUp Error"),console.error(b),setTimeout(function(){$("screen#signup #btn_signup").prop("disabled",!1)},3e3)}}),$("input, select, textarea, button").blur(),a.preventDefault()})},remE:function(){$("screen#signup #btn_cancel").hammer().off("tap"),$("screen#signup #frm_signup #txt_pass2").off("keyup"),$("screen#signup #frm_signup").off("submit")}},list:{initialize:function(){console.log("Determining user's location..."),app.getLocation(!0),console.log("Loading list of locations..."),$.when(views.screens.list.getData()).done(views.screens.list.render())},getData:function(){var a=Parse.User.current().get("location"),b=new Parse.Query(Parse.Object.extend("Locations"));b.near("Geo",a),b.find({success:function(a){meta.locations=Parse.Collection.extend({model:a})},error:function(a,b){console.log("Error querying location"),console.log(b)}})},render:function(){$("app screen").addClass("hidden"),$("screen#list content").html(""),$.when(views.screens.list.remE()).done(function(){meta.locations=Parse.Collection.extend({model:Parse.Object.extend("Locations")});var a=new meta.locations;a.fetch({success:function(a){var b=_.template($("#tpl_card").html());_.each(a.models,function(a){var c={};c.geo=a.get("Geo"),c.name=a.get("Name"),c.address=a.get("Address1"),c.d=utility.getDist(c.geo.longitude,c.geo.latitude),c.t=utility.getTimeToDist(c.d),$("screen#list content").append(b(c))}),views.screens.list.addE(),$("screen#list").removeClass("hidden")},error:function(a,b){console.log("Failed creating nearby collection"),console.log(b)}})})},remE:function(){return $("screen#list #btn_toggleMenu").hammer().off("tap"),$("screen#list #btn_refreshDistance").hammer().off("tap"),$("screen#list #btn_addLocation").hammer().off("tap"),!0},addE:function(){return $("screen#list #btn_toggleMenu").hammer().on("tap",function(){$(this).addClass("spinFaceLeft"),setTimeout(menu.show,300)}),$("screen#list #btn_refreshDistance").hammer().on("tap",function(){$(this).toggleClass("disabled"),$(this).toggleClass("infiniteSpin")}),$("screen#list #btn_addLocation").hammer().on("tap",function(){$.when(views.modals.addLocation.initialize()).done(views.modals.addLocation.show())}),!0}},detail:{initialize:function(){},getData:function(){},render:function(){}}},modals:{addLocation:{initialize:function(){$.when(views.modals.addLocation.remE()).done(views.modals.addLocation.addE())},show:function(){var a=Parse.Object.extend("Locations");meta.tempLocation=new a,views.modals.addLocation.getLocations(),$("screen").not(".hidden").addClass("fadeAway"),$("modal#addLocation").removeClass("viewportBottom"),$("modal#addLocation tabgroup#"+$("modal#addLocation tab.active").attr("for")).removeClass("hidden")},hide:function(){$("modal#addLocation").addClass("viewportBottom"),$("screen").not(".hidden").removeClass("fadeAway"),setTimeout(function(){$("modal#addLocation content tabgroup").addClass("hidden")},1e3)},getLocations:function(){0==meta.locations.length&&utility.reverseGeoCode(meta.geo.latitude,meta.geo.longitude,function(){meta.lastLocationSearch.results?($("modal#addLocation results").html(""),meta.lastLocationSearch.results.length>0&&$.each(meta.lastLocationSearch.results,function(a,b){b.sequence=a;var c=_.template($("#tpl_modal-addLocation_data-item").html());$("modal#addLocation results").append(c(b)),views.modals.addLocation.remListE(),views.modals.addLocation.addListE()})):console.log("Could not get nearby addresses")})},loadDataIntoForm:function(a){var b="",c=$("modal#addLocation #txt_name").val();$("modal#addLocation #frm_details")[0].reset(),$("modal#addLocation #txt_name").val(c),$("modal#addLocation #txt_lat").val(a.geometry.location.lat),$("modal#addLocation #txt_lng").val(a.geometry.location.lng),$.each(a.address_components,function(c,d){$.each(d.types,function(d,e){"locality"==e&&$("modal#addLocation #txt_city").val(a.address_components[c].short_name),"street_number"==e&&(b=a.address_components[c].short_name),"route"==e&&(b+=" "+a.address_components[c].short_name,$("modal#addLocation #txt_address1").val(b)),"administrative_area_level_1"==e&&$("modal#addLocation #txt_region").val(a.address_components[c].short_name),"country"==e&&$("modal#addLocation #txt_country").val(a.address_components[c].short_name),("postal_code"==e||"zip_code"==e)&&$("modal#addLocation #txt_code").val(a.address_components[c].short_name)})})},setData:function(){meta.tempLocation.set("createdBy",Parse.User.current()),meta.tempLocation.set("Name",name);var a=new Parse.GeoPoint({latitude:parseFloat($("modal#addLocation #txt_lat").val()),longitude:parseFloat($("modal#addLocation #txt_lng").val())});meta.tempLocation.set("Geo",a),meta.tempLocation.set("City",$("modal#addLocation #txt_city").val()),meta.tempLocation.set("Address1",$("modal#addLocation #txt_address1").val()),meta.tempLocation.set("Region",$("modal#addLocation #txt_region").val()),meta.tempLocation.set("Country",$("modal#addLocation #txt_country").val()),meta.tempLocation.set("Code",$("modal#addLocation #txt_code").val()),meta.tempLocation.save({success:function(a){console.log(a)},error:function(a,b){console.log(b)}}),meta.tempLocation=null,$("modal#addLocation #frm_details")[0].reset(),$("input, select, textarea, button").blur(),$("modal#addLocation results").html(""),views.modals.addLocation.hide()},remE:function(){$("modal#addLocation #btn_cancel").hammer().off("tap"),$("modal#addLocation #btn_save").hammer().off("tap"),$("modal#addLocation tabs tab").hammer().off("tap"),$("modal#addLocation form#frm_details #txt_address1, modal#addLocation form#frm_details #txt_city").off("blur"),$("modal#addLocation form#frm_details").off("submit")},addE:function(){$("modal#addLocation #btn_cancel").hammer().on("tap",function(){views.modals.addLocation.hide()}),$("modal#addLocation #btn_save").hammer().on("tap",function(){$.when(views.modals.addLocation.setData()).done(views.modals.addLocation.hide())}),$("modal#addLocation tabs tab").hammer().on("tap",function(){$("modal#addLocation tabs tab").removeClass("active"),$(this).addClass("active"),$("modal#addLocation tabgroup").addClass("hidden"),$("modal#addLocation tabgroup#"+$("modal#addLocation tab.active").attr("for")).removeClass("hidden")}),$("modal#addLocation form#frm_details #txt_address1, modal#addLocation form#frm_details #txt_city").on("blur",function(){var a=$("modal#addLocation #txt_address1").val()+","+$("modal#addLocation #txt_city").val();$.when(utility.geolocate(a)).done(function(b){console.log(a),console.log(b)})}),$("modal#addLocation form#frm_details").on("submit",function(a){var b=$("modal#addLocation #txt_address1").val()+","+$("modal#addLocation #txt_city").val(),c=utility.geolocate(b);console.log(b),console.log(c),$("input, select, textarea, button").blur(),a.preventDefault()})},remListE:function(){$("modal#addLocation form results item").hammer().off("tap")},addListE:function(){$("modal#addLocation form results item").hammer().on("tap",function(){$("modal#addLocation form results item").removeClass("selected"),$(this).addClass("selected");var a=parseInt($(this).data("id"));console.log(a),views.modals.addLocation.loadDataIntoForm(meta.lastLocationSearch.results[a])})}}}},menu={initialize:function(){$("menu").addClass("menu-left"),$("app").removeClass("tiltBack"),$.when(menu.remE()).done(menu.addE())},show:function(){console.log("Showing Menu"),$("app").addClass("tiltBack"),$("menu").removeClass("menu-left"),$("app screen").not(".hidden").each(function(a,b){window.views.screens[$(b).attr("id")].remE()}),setTimeout(function(){$("app").hammer().one("tap hold",function(){menu.hide()})},500)},hide:function(){console.log("Hiding Menu"),$("menu").addClass("menu-left"),$("app").removeClass("tiltBack"),$("app screen").not(".hidden").each(function(a,b){window.views.screens[$(b).attr("id")].addE()}),setTimeout(function(){$(".spinFaceLeft").removeClass("spinFaceLeft")},300)},remE:function(){$("menu #btn_menu_locations").hammer().off("tap"),$("menu #btn_menu_favs").hammer().off("tap"),$("menu #btn_menu_settings").hammer().off("tap"),$("menu #btn_menu_logout").hammer().off("tap")},addE:function(){$("menu #btn_menu_locations").hammer().on("tap",function(){}),$("menu #btn_menu_favs").hammer().on("tap",function(){}),$("menu #btn_menu_settings").hammer().on("tap",function(){}),$("menu #btn_menu_logout").hammer().on("tap",function(){Parse.User.logOut(),views.initialize()})}},utility={deg2rad:function(a){return a*(Math.PI/180)},getDist:function(a,b){var c={lon:a,lat:b},d=6371,e=utility.deg2rad(parseFloat(meta.geo.latitude)-parseFloat(c.lat)),f=utility.deg2rad(parseFloat(meta.geo.longitude)-parseFloat(c.lon)),g=Math.sin(e/2)*Math.sin(e/2)+Math.cos(utility.deg2rad(parseFloat(c.lat)))*Math.cos(utility.deg2rad(parseFloat(meta.geo.latitude)))*Math.sin(f/2)*Math.sin(f/2),h=2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g)),i=d*h,j=+i.toFixed(2);return j},getTimeToDist:function(a,b){b||(b=35);var c=a/b*60,d=+c.toFixed(0);return d},openAppleMaps:function(a,b){window.location.href="maps://maps.apple.com/?q="+b+","+a},geolocate:function(a){var b={};$.getJSON("https://maps.googleapis.com/maps/api/geocode/json?address="+encodeURI(a)+"&key="+meta.keys.google.current).done(function(a){return meta.tempGeolocate=a,b=a.results[0].geometry.location,meta.locations=a.results,b}).fail(function(a,b,c){console.error(c)})},reverseGeoCode:function(a,b,c){var d="https://maps.googleapis.com/maps/api/geocode/json?latlng="+a+","+b+"&key="+meta.keys.google.current;$.getJSON(d).done(function(a){console.log("Got address(es)"),meta.lastLocationSearch=a}).fail(function(a,b,c){console.error(c)}).always(c)}};$(function(){app.initialize()});